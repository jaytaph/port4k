version: 4
id: observation_nook
name: Observation Nook
short: "A dim alcove with narrow viewports and a bench."
description: |
  The alcove widens just enough for a bench under a row of narrow viewports. Beyond the armored glass, a starfield drifts past, broken by the dark geometry of station struts. A patchy {o:wall_map} is bolted beside the bench, and a scuffed {o:storage_locker} sits half-tucked under it. A faint draft whispers through a {o:vent_grille} near the floor. The brighter corridor lies {o:east_exit}.

kv:
  ambience: "quiet_hum"
  view: "starfield"

hints:
  - id: map
    text: "Maps often hide route notes—try reading or tracing markings."
    when: first_look
    once: true
  - id: locker
    text: "Lockers may require codes, tools, or a lucky shove."
    when: enter
    cooldown: 2
  - id: grille
    text: "A loose grille could conceal stashed items."
    when: search
    once: true
  - id: viewport
    text: "The viewport offers lore and orientation—try 'scan' here too."
    when: manual

objects:
  - id: wall_map
    nouns: ["map","wall map","chart"]
    short: "patched wall map"
    description: "A faded sector chart with hand-scratched updates."
    examine: "Someone added a note: 'MBAY spare code → mirrored of ENTRY'."
    on_use: |
      return function(ctx, verb, args)
        if verb == "read" or verb == "examine" or verb == "scan" then
          ctx:say("The annotations show patrol routes and docking lanes. One scribble hints a locker code mirror puzzle.")
          return true
        end
        return false
      end

  - id: storage_locker
    nouns: ["locker","storage","box"]
    short: "scuffed storage locker"
    description: "A metal locker with a numeric keypad and dented side."
    flags:
      locked: true
    state:
      opened: false
    examine: "Keypad shows smudges on 1, 2, 3, 4. The dented panel might pry with the right tool."
    on_use: |
      return function(ctx, verb, args)
        if verb == "enter" and #args > 0 then
          local code = table.concat(args, " ")
          -- 'Mirrored of ENTRY' → entry console code '4312' mirrored horizontally -> '2134'
          if code == "2134" then
            ctx:set_object_state("storage_locker","locked", false)
            ctx:say("A chirp, then the lock releases with a soft clunk.")
          else
            ctx:say("The keypad buzzes angrily. Wrong code.")
          end
          return true
        end
        if (verb == "open" or verb == "loot") then
          if ctx:get_object_state("storage_locker","locked") then
            if ctx:has_item("multi_spanner") then
              ctx:say("You work the dent with the multi-spanner, flexing the frame just enough to pop the latch.")
              ctx:set_object_state("storage_locker","locked", false)
            else
              ctx:say("It's still locked. The frame looks susceptible to leverage… if you had the right tool.")
              return true
            end
          end
          if not ctx:get_object_state("storage_locker","opened") then
            ctx:set_object_state("storage_locker","opened", true)
            ctx:give_item("energy_cell")
            ctx:give_credits(25)
            ctx:say("Inside you find an **energy cell** and a handful of station scrip.")
          else
            ctx:say("The locker is empty.")
          end
          return true
        end
        return false
      end

  - id: vent_grille
    nouns: ["vent","grille","grate"]
    short: "loose vent grille"
    description: "A rectangular grille with two missing screws."
    state:
      loosened: false
      cache_taken: false
    examine: "You can wiggle it; the screws are barely holding."
    on_use: |
      return function(ctx, verb, args)
        if verb == "unscrew" or verb == "open" then
          if not ctx:get_object_state("vent_grille","loosened") then
            if ctx:has_item("fiber_probe") then
              ctx:set_object_state("vent_grille","loosened", true)
              ctx:say("You lever the remaining screws with the fiber probe and ease the grille aside.")
            else
              ctx:say("You need something thin to work the screws—maybe a probe.")
              return true
            end
          end
          if not ctx:get_object_state("vent_grille","cache_taken") then
            ctx:set_object_state("vent_grille","cache_taken", true)
            ctx:give_item("aurelite_fragment")
            ctx:say("Behind the grille, a small pouch holds an **Aurelite fragment**.")
          else
            ctx:say("Only dust and a few errant fasteners remain.")
          end
          return true
        end
        return false
      end

  - id: east_exit
    nouns: ["east","hallway"]
    short: "bright corridor east"
    description: "Light spills in from the main corridor."
    examine: "You can hear the faint beep of a distant panel."

exits:
  - dir: east
    to: "hallway_1"
    description: "Back to the reinforced hallway."
    locked: false
    visible_when_locked: true

scripts:
  on_enter: |
    return function(ctx)
      ctx:say("Stars drift beyond the narrow glass; the station’s slow spin tugs at your inner ear.")
    end
  on_command: |
    return function(ctx, verb, args)
      if verb == "scan" then
        ctx:say("Scan: no life signs; weak airflow through vent; minor EM noise from an old locker keypad.")
        return true
      end
      return false
    end
