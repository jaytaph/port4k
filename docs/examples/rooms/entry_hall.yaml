version: 3
id: entry
name: Entry Hall
short: "A small, quiet room lit by phosphor glow."
description: |
  The room is narrow and still, its curved walls lined with pale panels that pulse faintly with phosphorescent light. The glow casts long shadows across the floor, where fine dust has gathered in the seams of the metal plates. A faint hum from hidden conduits echoes in the silence, broken only by the occasional drip of condensation from overhead pipes.

  To the north, a {o:blast_door} blocks further passage. A {o:wall_console} beside it blinks weakly. Near the corner, a {o:toolkit} lies half-buried in dust. Etched into the wall are faint {o:markings}.

# Free-form room KV available to Lua and UI
state:
  ambience: "low_hum"
  dust_level: "high"

hints:
  - id: blast_door_locked
    text: "The blast door might be locked; perhaps there's a way to unlock it."
    when: first_look
    once: true
  - id: console_damaged
    text: "The console looks damaged but might still be usable."
    when: enter
    cooldown: 3
  - id: toolkit_items
    text: "The toolkit could contain useful items."
    when: search
    once: true
  - id: console_code_help
    text: "Try: 'enter 4312 on console' after powering it."
    when: after_fail        # e.g., after a wrong 'enter' attempt
    cooldown: 2

objects:
  - id: blast_door
    nouns: ["door","blast door"]
    short: "sealed blast door"
    description: "A heavy composite barrier with old scoring along the seams."
    flags: ["overlay","non_stackable"]   # keeps door visible even if another overlay exists
    visible: always
    state:
      locked: true
      powered: true
      revealed: true
    controls:
      - exit:north.locked                 # keep exit lock in sync with this door
    examine: "The locking mechanism is intact; manual overrides are scarred but functional."
    use: |
      return function(ctx)
        local exit = "north"
        port4k.say("DEBUG: Checking blast door use")
          
        if ctx.intent.verb == "open" then
            if not ctx.room.exits[exit] then
                port4k.say("There is no door here to open.")
            end
            if ctx.object.locked then
                port4k.say("The door is locked tight.")
                return true
            end
            if ctx.object.locked == false then
                port4k.say("It's already open.")
                return true
            end
            port4k.say("Hydraulics hiss as the blast door slides open.")
            port4k.set_exit_locked(exit, false)
            return true
    
        elseif ctx.intent.verb == "close" then
            if port4k.is_exit_locked(exit) == true then
                port4k.say("It's already closed.")
                return true
            end
            port4k.say("The blast door rumbles shut.")
            port4k.set_exit_locked(exit, true)
            return true
        end
    
        return false
      end

  - id: wall_console
    nouns: ["console","terminal","panel"]
    short: "flickering wall console"
    description: "A recessed maintenance terminal with a cracked display."
    flags: []
    visible: always
    state:
      powered: false
      code_required: "4312"
      revealed: true
    examine: "Power is intermittent; a maintenance login prompt flickers in and out."
    use: |
      -- Supported inputs:
      --   use console
      --   power console with <item>
      --   enter <code> on console
      return function(ctx)
        local powered = ctx.object.state.powered
        if not powered then
          if verb == "power" and port4k.player_has_item("microcell") then
            port4k.set_object_state("wall_console","powered", true)
            port4k.consume_item("microcell")
            port4k.say("You slot the microcell. The console hums to life.")
            return true
          else
            port4k.say("The console is dead. You might power it with a microcell.")
            return true
          end
        end

        if verb == "enter" and #args > 0 then
          local code = table.concat(args, " ")
          local required = ctx.object.code_required or "4312"
          if code == required then
            port4k.say("Code accepted. Releasing blast door locks.")
            port4k.set_object_state("blast_door","locked", false)
          else
            port4k.say("{c:bright_white:bright_red}ACCESS DENIED{c}")
            port4k.hint_trigger("after_fail")    -- lets the engine consider an after_fail hint
          end
          return true
        end

        if verb == "use" then
          port4k.say("The console awaits a code. Try: enter <code> on console")
          return true
        end

        return false
      end

  - id: toolkit
    nouns: ["toolkit","tools","case"]
    short: "discarded toolkit"
    description: "A battered case; one latch is broken."
    flags: []
    visible: when_revealed
    state:
      revealed: true
    examine: "Inside: a multi-spanner, fiber probe, and a microcell."
    loot:
      items:
        - "multi_spanner"
        - "fiber_probe"
        - "microcell"         # charged, for a simple first-room loop
      credits: 0
      once: true

  - id: markings
    nouns: ["markings","symbols","etchings"]
    short: "etched markings"
    description: "Jagged symbols carved into the wall paint."
    flags: []
    visible: always
    state:
      revealed: true
    examine: "The symbols loosely match hazard glyphs for 'pressure loss' and 'quarantine'."

exits:
  - dir: north
    to: "hallway_1"
    description: "A reinforced corridor beyond the door."
    locked: true
    visible_when_locked: true

scripts:
  on_enter: |
    return function(ctx)
      if not ctx.room.objects["wall_console"].state["powered"] then
        port4k.say("The console flickers once and dies. It might need a power source.")
      end
      port4k.hint_consider("enter")    -- engine may surface an 'enter' hint
    end
  on_command: |
    port4k.say("OnCommand")
    -- Allow "read markings"
    return function(ctx, verb, args)
      if verb == "read" and port4k.matches_noun(args, {"markings","symbols","etchings"}) then
        port4k.say("The symbols resemble hazard glyphs: 'pressure loss' and 'quarantine'.")
        return true
      end
      return false
    end


# Optional: inline item catalog (skip if you have a global one)
items_catalog:
  - id: multi_spanner
    name: "Multi-Spanner"
    stackable: false
  - id: fiber_probe
    name: "Fiber Probe"
    stackable: false
  - id: microcell
    name: "Microcell"
    stackable: true
